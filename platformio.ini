; PlatformIO Project Configuration File
;
; eBike Battery CANBUS Monitor
; ESP32-based battery monitoring system with CAN, WiFi, and MQTT
[platformio]
default_envs = nodemcu-32s

[env:nodemcu-32s]
platform = espressif32
board = nodemcu-32s
framework = arduino

; Serial Monitor
monitor_speed = 115200
monitor_filters = esp32_exception_decoder

; C++ standard
build_unflags = -std=gnu++11

; Build flags
build_flags =
    -std=gnu++17
    -DCORE_DEBUG_LEVEL=3
    -DCONFIG_ARDUHAL_LOG_COLORS=1
    -DASYNCWEBSERVER_REGEX
    -Wall
    -Wextra

; Filesystem
board_build.filesystem = spiffs
board_build.partitions = default.csv

; Library dependency finder mode
lib_ldf_mode = chain+
lib_ignore = WebServer

; Library dependencies
lib_deps =
    https://github.com/me-no-dev/ESPAsyncWebServer.git
    https://github.com/me-no-dev/AsyncTCP.git
    bblanchon/ArduinoJson@^7.0.0
    knolleary/PubSubClient@^2.8

; Upload settings
upload_speed = 921600
upload_port = /dev/ttyUSB0
monitor_port = /dev/ttyUSB0

; =============================================================================
; Test Environments
; =============================================================================

; Test Settings Manager
[env:test_settings]
platform = ${env:nodemcu-32s.platform}
board = ${env:nodemcu-32s.board}
framework = ${env:nodemcu-32s.framework}
monitor_speed = ${env:nodemcu-32s.monitor_speed}
monitor_filters = ${env:nodemcu-32s.monitor_filters}
build_unflags = ${env:nodemcu-32s.build_unflags}
build_flags = ${env:nodemcu-32s.build_flags}
upload_speed = ${env:nodemcu-32s.upload_speed}
board_build.filesystem = ${env:nodemcu-32s.board_build.filesystem}

; Override source file
build_src_filter =
    +<../examples/settings_test.cpp>
    +<config/>

; No libraries needed for settings test
lib_deps =

; Test CAN Driver
[env:test_can]
platform = ${env:nodemcu-32s.platform}
board = ${env:nodemcu-32s.board}
framework = ${env:nodemcu-32s.framework}
monitor_speed = ${env:nodemcu-32s.monitor_speed}
monitor_filters = ${env:nodemcu-32s.monitor_filters}
build_unflags = ${env:nodemcu-32s.build_unflags}
build_flags = ${env:nodemcu-32s.build_flags}
upload_speed = ${env:nodemcu-32s.upload_speed}
board_build.filesystem = ${env:nodemcu-32s.board_build.filesystem}

; Override source file
build_src_filter =
    +<../examples/can_test.cpp>
    +<config/>
    +<can/>
    +<utils/>

lib_deps =

; Test Battery Manager
[env:test_battery]
platform = ${env:nodemcu-32s.platform}
board = ${env:nodemcu-32s.board}
framework = ${env:nodemcu-32s.framework}
monitor_speed = ${env:nodemcu-32s.monitor_speed}
monitor_filters = ${env:nodemcu-32s.monitor_filters}
build_unflags = ${env:nodemcu-32s.build_unflags}
build_flags = ${env:nodemcu-32s.build_flags}
upload_speed = ${env:nodemcu-32s.upload_speed}
board_build.filesystem = ${env:nodemcu-32s.board_build.filesystem}

; Override source file
build_src_filter =
    +<../examples/battery_test.cpp>
    +<config/>
    +<battery/>
    +<can/>
    +<utils/>

lib_deps =
